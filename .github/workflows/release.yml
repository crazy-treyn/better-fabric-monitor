name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  actions: read
  pull-requests: read

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  resolve-artifact:
    name: Locate PR Build
    runs-on: ubuntu-latest
    outputs:
      build_run_id: ${{ steps.resolve.outputs.result }}
    steps:
      - name: Find successful pull request build
        id: resolve
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const { owner, repo } = context.repo;
            const targetSha = context.sha;
            const prs = await github.paginate(
              github.rest.repos.listPullRequestsAssociatedWithCommit,
              {
                owner,
                repo,
                commit_sha: targetSha,
                per_page: 50,
                mediaType: { previews: ['groot'] }
              }
            );
            const candidateShas = new Set([targetSha]);
            for (const pr of prs) {
              if (pr?.head?.sha) {
                candidateShas.add(pr.head.sha);
              }
              if (pr?.merge_commit_sha) {
                candidateShas.add(pr.merge_commit_sha);
              }
            }
            const runs = await github.paginate(
              github.rest.actions.listWorkflowRuns,
              { owner, repo, workflow_id: 'build.yml', per_page: 50 }
            );
            const match = runs.find(run =>
              run.conclusion === 'success' &&
              run.event === 'pull_request' &&
              candidateShas.has(run.head_sha)
            );
            if (match) {
              core.info(`Reusing build workflow run ${match.id} for commit ${targetSha}.`);
              return String(match.id);
            } else {
              core.info('No matching pull request build found for this tag. A fresh build will be created.');
              return '';
            }

  reuse-build:
    name: Reuse PR Artifact
    needs: resolve-artifact
    if: needs.resolve-artifact.outputs.build_run_id != ''
    runs-on: windows-latest
    outputs:
      source: ${{ steps.marker.outputs.source }}
    steps:
      - name: Download pull request artifact
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ needs.resolve-artifact.outputs.build_run_id }}
          name: better-fabric-monitor-windows
          path: release-assets

      - name: Stage executable
        run: |
          $src = Get-ChildItem -Path release-assets -Recurse -Filter better-fabric-monitor.exe | Select-Object -First 1
          if (-not $src) { throw 'Executable not found in downloaded artifact.' }
          New-Item -ItemType Directory -Path build\bin -Force | Out-Null
          Copy-Item -Path $src.FullName -Destination build\bin\better-fabric-monitor.exe -Force
        shell: pwsh

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-binary
          path: build/bin/better-fabric-monitor.exe
          retention-days: 7

      - name: Mark artifact source
        id: marker
        run: echo "source=reused" >> $env:GITHUB_OUTPUT
        shell: pwsh

  fallback-build:
    name: Build From Source
    needs: resolve-artifact
    if: needs.resolve-artifact.outputs.build_run_id == ''
    uses: ./.github/workflows/windows-build.yml
    with:
      artifact-name: release-binary
    secrets: inherit

  publish:
    name: Publish Release
    needs:
      - resolve-artifact
      - reuse-build
      - fallback-build
    if: ${{ always() && (needs.reuse-build.result == 'success' || needs.fallback-build.result == 'success') }}
    runs-on: windows-latest
    steps:
      - name: Download release artifact
        uses: actions/download-artifact@v4
        with:
          name: release-binary
          path: build/bin

      - name: Note artifact source
        run: |
          if ('${{ needs.reuse-build.result }}' -eq 'success') {
            Write-Host 'Using executable from pull request build.'
          } else {
            Write-Host 'Using executable from release build.'
          }
        shell: pwsh

      - name: Generate SHA-256 checksum
        run: |
          $hash = (Get-FileHash -Algorithm SHA256 build/bin/better-fabric-monitor.exe).Hash
          $hash | Out-File -Encoding ASCII -NoNewline build/bin/better-fabric-monitor.exe.sha256
        shell: pwsh

      - name: Verify build artifacts
        run: |
          if (!(Test-Path build/bin/better-fabric-monitor.exe)) {
            Write-Error 'Build failed: executable not found'
            exit 1
          }
          if (!(Test-Path build/bin/better-fabric-monitor.exe.sha256)) {
            Write-Error 'Build failed: checksum file not found'
            exit 1
          }
          $size = (Get-Item build/bin/better-fabric-monitor.exe).Length / 1MB
          Write-Host "✓ Executable size: $([math]::Round($size, 2)) MB"
          Write-Host "✓ SHA-256: $(Get-Content build/bin/better-fabric-monitor.exe.sha256)"
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/bin/better-fabric-monitor.exe
            build/bin/better-fabric-monitor.exe.sha256
          body: |
            ## Installation
            
            1. Download `better-fabric-monitor.exe`
            2. (Optional) Verify integrity:
               ```powershell
               $expected = (Get-Content better-fabric-monitor.exe.sha256).Trim()
               $actual = (Get-FileHash better-fabric-monitor.exe).Hash
               if ($expected -eq $actual) { Write-Host "✓ Checksum verified" } else { Write-Error "✗ Checksum mismatch!" }
               ```
            3. Run the application
            
            ## Prerequisites
            
            - Windows 10/11 with WebView2 Runtime (pre-installed on modern Windows)
          draft: true
          prerelease: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}